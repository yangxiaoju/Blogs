# 提高绘图性能

在任何平台上绘图都是一项相对昂贵的操作，优化绘图代码应始终是开发过程中的重要一步。表A-1列出了几种确保绘图代码尽可能最佳的技巧。除了这些提示之外，你还应始终使用可用的性能工具来测试代码并删除热点和冗余。

表 A-1 提高绘图性能的技巧

| Tip | Action |
| - | - |
| 最小量绘制 | 在每个更新周期中，你应该只更新视图中实际更改的部分。如果你使用 UIView 的 drawRect: 方法来绘制图形，请使用传递给该方法的更新矩形来限制绘图的范围。对于 OpenGL 绘图，你必须自己跟踪更新。 |
| 明智地调用 setNeedsDisplay: | 如果你正在调用 setNeedsDisplay:,请始终花时间计算你需要重绘的实际区域。不要只传递包含整个视图的矩形。此外，不要调用 setNeedsDisplay: 除非你确实需要重绘内容。如果内容实际上没有更改，请不要重绘。 |
| 标记不透明的视图 | 合成内容不透明的视图比合成部分透明的视图要少得多。要使视图不透明，视图的内容不得包含任何透明度，并且视图的 opaque 属性必须设置为 YES。 |
| 滚动期间重用 table cells 和视图 | 应该不惜一切代价避免在滚动期间创建新视图。花时间创建新视图减少了更新屏幕的可用时间，从而导致不均匀的滚动行为。 |
| 通过修改当前转换矩阵来重用路径 | 通过修改当前转换矩阵，你可以使用单个路径在屏幕的不同部分上绘制内容。有关详细信息，请参阅 Using Coordinate Transforms to Improve Drawing Performance。 |
| 滚动期间避免清除以前的内容 | 默认情况下，UIKit 在调用其 drawRect: 方法之前清除视图的当前上下文缓冲区以更新同一区域。如果你要响应视图中的滚动事件，则在滚动更新期间反复清除此区域可能会非常昂贵。要禁用该行为，可以将 clearsContextBeforeDrawing 属性中的值更改为 NO。 |
| 绘图时最小化图形状态更改 | 更改图形状态需要底层图形子系统的工作。如果你需要绘制使用类似状态信息的内容，请尝试将该内容绘制在一起以减少所需的状态更改次数。 |
| 使用 Instruments 调试性能 | Core Animation 工具可以帮助你发现应用中的绘图性能问题。特别是：1、Flash Updated Regions 可让你轻松查看视图的哪些部分实际更新。2、颜色未对齐图像可帮助你查看对齐不良的图像，从而导致图像模糊和性能不佳。有关更多信息，请参阅 Your iOS Device in Instruments User Guide 中的 Measuring Graphics Performance。 |