# 访问缓存数据

控制 URL 请求如何使用以前缓存的数据。

## 概览

URL加载系统在内存和磁盘上缓存响应，从而提高性能并减少网络流量。

URLCache 类用于缓存来自网络资源的响应。你的应用程序可以使用 URLCache 的 shared 属性直接访问共享缓存实例。或者，你可以为不同目的创建自己的缓存，在 URLSessionConfiguration 对象上设置不同的缓存。

## 为 URL 请求设置缓存策略

每个 URLRequest 实例都包含一个 URLRequest.CachePolicy 对象，用于指示是否以及如何执行缓存。你可以更改此策略以控制请求的缓存。

为方便起见，URLSessionConfiguration 有一个名为 requestCachePolicy 的属性; 从使用此配置的会话创建的所有请求都从配置继承其缓存策略。

表格 1 缓存策略及其行为

| Cache policy | Local cache | Originating source |
| - | - |
| NSURLRequest.CachePolicy.reloadIgnoringLocalCacheData | Ignored | Accessed exclusively |
| NSURLRequest.CachePolicy.returnCacheDataDontLoad | Accessed exclusively | Ignored |
| NSURLRequest.CachePolicy.returnCacheDataElseLoad | Tried first | Accessed only if needed |
| NSURLRequest.CachePolicy.useProtocolCachePolicy | Depends on protocol | Depends on protocol |

有关如何为 HTTP 和 HTTPS 实现 useProtocolCachePolicy 的说明，请参阅 NSURLRequest.CachePolicy。useProtocolCachePolicy 是 URLRequest 对象的默认值。

> 注意：usePrococolCachePolicy 将 HTTPS 响应缓存到磁盘，这对于保护用户数据可能是不合需要的。你可以通过手动处理缓存行为来更改此行为，如 Manage Caching Programmatically 中所述。

## 直接访问缓存

你可以使用会话配置对象的 urlCache 属性来获取或设置 URLSession 对象使用的缓存对象。

要查找对给定请求的缓存响应，请在缓存上调用 cachedResponse(for:) 。如果请求存在缓存数据，则此调用返回 CachedURLResponse 对象; 否则，它返回 nil。

你可以检查缓存使用的资源。currentDiskUsage 和 diskCapacity 属性表示缓存使用的文件系统资源，currentMemoryUsage 和 memoryCapacity 表示内存使用。

你可以使用 removeCachedResponse(for:) 删除单个项目的缓存数据。你还可以使用 removeCachedResponses(since:) 同时清除许多缓存项目，它会删除超过给定日期的缓存项目，或 removeAllCachedResponses()，它会擦除整个缓存。

## 以编程方式管理缓存

你可以使用 storeCachedResponse(_:for:) 方法以编程方式写入缓存，并传入新的 CachedURLResponse 对象和 URLRequest 对象。

通常，你在 URLSessionTask 对象处理响应时管理响应的缓存。要在每个响应的基础上管理缓存，请实现 URLSessionDataDelegate 协议的 urlSession(_:dataTask:willCacheResponse:completionHandler:)  方法。请注意，此 delegate 方法仅针对上传和数据任务调用，而不会针对具有后台或临时配置的会话调用。

delegate 接收两个参数：CachedURLResponse 对象和 completion handler。你的 delegate 必须直接调用此 completion handler，并传递以下内容之一：

- 提供的 CachedURLResponse 对象，用于按原样缓存建议的响应
- nil，以防止缓存
- 新创建的 CachedURLResponse 对象，通常基于提供的对象，但具有修改后的 storagePolicy 和 userInfo 字典，如你所见

清单1显示了 urlSession(_:dataTask:willCacheResponse:completionHandler:) 的实现，它拦截对 HTTPS 请求的响应，并允许响应仅存储在内存缓存中。

清单 1 处理 urlSession(_:dataTask:willCacheResponse:completionHandler:)  回调

```swift
func urlSession(_ session: URLSession, dataTask: URLSessionDataTask,
                willCacheResponse proposedResponse: CachedURLResponse,
                completionHandler: @escaping (CachedURLResponse?) -> Void) {
    if proposedResponse.response.url?.scheme == "https" {
        let updatedResponse = CachedURLResponse(response: proposedResponse.response,
                                                data: proposedResponse.data,
                                                userInfo: proposedResponse.userInfo,
                                                storagePolicy: .allowedInMemoryOnly)
        completionHandler(updatedResponse)
    } else {
        completionHandler(proposedResponse)
    }
}
```