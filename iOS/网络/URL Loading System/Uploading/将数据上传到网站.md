# 将数据上传到网站

将数据从你的应用发布到服务器。

## 概览

许多应用程序使用接受上传文件（如图像或文档）的服务器，或使用接受结构化数据（如 JSON）的 Web 服务 API 端点。要从应用程序上传数据，请使用 URLSession 实例创建 URLSessionUploadTask 实例。上传任务使用 URLRequest 实例，该实例详细说明了如何执行上传。

## 准备上传数据

要上载的数据可以是文件，流或数据的内容，如清单1所示。

许多 Web 服务端点采用 JSON 格式的数据，你可以使用类似数组和字典等 Encodable 类型的 JSONEncoder 类创建这些数据。如清单1所示，你可以声明符合 Codable 的结构，创建此类型的实例，并使用 JSONEncoder 将实例编码为 JSON 数据以进行上传。

清单 1 准备 JSON 数据以进行上载

```swift
struct Order: Codable {
    let customerId: String
    let items: [String]
}

// ...

let order = Order(customerId: "12345",
                  items: ["Cheese pizza", "Diet soda"])
guard let uploadData = try? JSONEncoder().encode(order) else {
    return
}
```

还有许多其他方法可以创建数据实例，例如将图像编码为 JPEG 或 PNG 数据，或者使用 UTF-8 等编码将字符串转换为数据。

## 配置上传请求

上传任务需要 URLRequest 实例。如清单2所示，将请求的 httpMethod 属性设置为“POST”或“PUT”，具体取决于服务器支持和期望的内容。使用 setValue(_:forHTTPHeaderField:) 方法设置要提供的任何 HTTP 标头的值，但 Content-Length 标头除外。会话根据数据大小自动计算内容长度。

清单 2 配置 URL 请求

```swift
let url = URL(string: "https://example.com/post")!
var request = URLRequest(url: url)
request.httpMethod = "POST"
request.setValue("application/json", forHTTPHeaderField: "Content-Type")
```

## 创建并启动上传任务

要开始上传，请在 URLSession 实例上调用 uploadTask(with:from:completionHandler:)  来创建上传 URLSessionTask 实例，传入请求和你之前设置的数据实例。由于任务以挂起状态启动，因此你可以通过调用任务上的 resume() 来开始网络加载过程。清单3使用共享的 URLSession 实例，并在 completion handler 中接收其结果。handler 在使用任何返回的数据之前检查传输和服务器错误。

清单 3 开始上传任务

```swift
let task = URLSession.shared.uploadTask(with: request, from: uploadData) { data, response, error in
    if let error = error {
        print ("error: \(error)")
        return
    }
    guard let response = response as? HTTPURLResponse,
        (200...299).contains(response.statusCode) else {
        print ("server error")
        return
    }
    if let mimeType = response.mimeType,
        mimeType == "application/json",
        let data = data,
        let dataString = String(data: data, encoding: .utf8) {
        print ("got data: \(dataString)")
    }
}
task.resume()
```

## 或者，通过设置 delegate 上传

作为 completion handler 方法的替代方法，你可以在你配置的会话上设置 delegate，然后使用 uploadTask(with:from:) 创建上传任务。在此方案中，你将实现 URLSessionDelegate 和 URLSessionTaskDelegate 协议中的方法。这些方法接收服务器响应以及任何数据或传输错误。