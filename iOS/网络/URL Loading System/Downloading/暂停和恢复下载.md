# 暂停和恢复下载

允许用户在不重新开始的情况下恢复下载。

## 概览

你的应用或用户可能需要取消正在进行的下载并在以后恢复。通过支持可恢复的下载，你可以节省用户的时间和网络带宽。

你还可以使用此技术恢复因临时连接丢失而失败的下载。

## 取消下载时存储恢复数据对象

你通过调用 cancel(byProducingResumeData:) 取消 URLSessionDownloadTask。该方法采用 completion handler，一旦取消完成就调用该处理程序。completion handler 接收 resumeData 参数。如果它不是 nil，则这是你稍后用于恢复下载的令牌。清单1显示了如何取消下载任务并将 resumeData（如果存在）存储在属性中。

清单 1 取消下载时存储恢复数据

```swift
downloadTask.cancel { resumeDataOrNil in
    guard let resumeData = resumeDataOrNil else { 
      // download can't be resumed; remove from UI if necessary
      return
    }
    self.resumeData = resumeData
}
```

> 重要：并非所有下载都可以恢复。请参阅 cancel(byProducingResumeData:) 中的讨论，以获取下载可恢复必须满足的条件列表。此外，使用后台配置的下载将自动处理恢复，因此只有非后台下载才需要手动恢复。

## 下载失败时存储恢复数据对象

你还可以恢复因暂时失去连接而失败的下载，例如当用户走出 WiFi 范围时。

当下载失败时，会话将调用你的 urlSession(_:task:didCompleteWithError:) delegate 方法。如果 error 不是 nil，请在其 userInfo 字典中查找密钥 NSURLSessionDownloadTaskResumeData。如果密钥存在，请保存与其关联的值，以便稍后在尝试恢复下载时使用。 如果密钥不存在，则无法恢复下载。

清单2显示了 urlSession(_:task:didCompleteWithError:) 的实现，它从错误中检索并保存 resumeData 对象（如果有）。

```swift
func urlSession(_ session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?) {
    guard let error = error else {
        // Handle success case.
        return
    }
    let userInfo = (error as NSError).userInfo
    if let resumeData = userInfo[NSURLSessionDownloadTaskResumeData] as? Data {
        self.resumeData = resumeData
    } 
    // Perform any other error handling.
}
```

## 使用存储的恢复数据对象恢复下载

当适合恢复下载时，使用 URLSession 的 downloadTask(withResumeData:) 或 downloadTask(withResumeData:completionHandler:) 方法创建一个新的 URLSessionDownloadTask，传入你之前存储的 resumeData 对象。然后在任务上调用 resume() 以恢复下载。

清单 3 从 resume data 创建和启动下载任务

```swift
guard let resumeData = resumeData else {
    // inform the user the download can't be resumed
    return
}
let downloadTask = urlSession.downloadTask(withResumeData: resumeData)
downloadTask.resume()
self.downloadTask = downloadTask
```

如果下载成功恢复，该任务将调用你的 delegate 的 urlSession(_:downloadTask:didResumeAtOffset:expectedTotalBytes:) 方法。你可以使用偏移量和字节数参数来通知用户下载已恢复并保留其早期进度。

